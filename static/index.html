<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="static/Chart.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        function drawMemory(canvas, values) {
            //console.log(values);
            // Generate the array with the used values
            var used = [];
            var cached = [];
            var labels = [];
            for (var i = 0; i < values.length; i++) {
                used.push(values[i].used);
                cached.push(values[i].cached);
                labels.push('');
            }

            var ctx = canvas.getContext("2d");
            var data = {
                labels: labels,
                datasets: [
                    {
                        label: "Memory usage",
                        fillColor: "rgba(220,220,220,0.2)",
                        strokeColor: "rgba(220,220,220,1)",
                        pointColor: "rgba(220,220,220,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(220,220,220,1)",
                        data: used
                    },
                    {
                        label: "Cached",
                        fillColor: "rgba(110,110,110,0.2)",
                        strokeColor: "rgba(110,110,110,1)",
                        pointColor: "rgba(110,110,110,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(110,110,220,1)",
                        data: cached
                    }
                ]
            };
            var chart = new Chart(ctx).Line(data, {});
        }

        $(document).ready(function() {
            Chart.defaults.global.animation = false;

            var socket = io.connect('http://' + document.domain + ':' + location.port);
            socket.on('connect', function() {
                socket.emit('client_connected', {data: 'Client connected!'});
                console.log('Connected to socket!');
            });

            socket.on('update_status', function(stat) {
                // See if we have the info for the server
                var serverDisplayName = '#serverDisplay #'+stat.server;
                if (!$(serverDisplayName).length) {
                    console.log("Got new server: "+stat.server);
                    // Create the <div> that will contain the graphics
                    $('#serverDisplay').append($('<div/>', { id: stat.server }));

                    // Create the graphics
                    $(serverDisplayName).append($('<canvas/>', { id: 'memory' }));
                    $(serverDisplayName).append($('<canvas/>', { id: 'disk' }));
                }

                switch (stat.statusType) {
                case 'memory':
                    var canvas = $(serverDisplayName+' #memory').get(0);
                    drawMemory(canvas, stat.lastValues);
                    break;
                };
            });

            var lastReads = [];

            socket.on('my_status', function(theStatus) {
                lastReads.push(theStatus.free);
                if (lastReads.length >= 10)
                    lastReads = lastReads.slice(1, 10);
                console.log(lastReads);   

                $("#free").html(theStatus.free);
                $("#total").html(theStatus.total);

                var ctx = $("#memoryChart").get(0).getContext("2d");
                var data = {
                    labels: lastReads,
                    datasets: [
                        {
                            label: "Memory usage",
                            fillColor: "rgba(220,220,220,0.2)",
                            strokeColor: "rgba(220,220,220,1)",
                            pointColor: "rgba(220,220,220,1)",
                            pointStrokeColor: "#fff",
                            pointHighlightFill: "#fff",
                            pointHighlightStroke: "rgba(220,220,220,1)",
                            data: lastReads
                        }
                    ]
                };
                var chart = new Chart(ctx).Line(data, {});
            });
        });
    </script>
</head>

<body>
    <div id="serverDisplay" />
</body>
</html>
